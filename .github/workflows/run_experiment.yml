name: Run Experiment

on:
  issues:
    types: [opened, edited]

jobs:
  run-experiment:
    if: |
      contains(join(github.event.issue.labels.*.name, ','), 'experiment') ||
      startsWith(github.event.issue.title, '[Experiment]')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run experiment
        id: run-experiment
        env:
          AWS_BEARER_TOKEN_BEDROCK: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
        run: |
          python -m src.issue_processor_github "${{ github.event.issue.body }}" "${{ github.event.issue.number }}"
          # The script will exit with code 1 if success rate < 100%, causing the workflow to fail
      
      - name: Comment results on issue
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## Experiment Results\n\n';
            
            // Try to read results file using experiment_summary.json to get the correct experiment_id
            const resultsDir = path.join(process.cwd(), 'docs', 'results');
            const summaryPath = path.join(resultsDir, 'experiment_summary.json');
            
            if (fs.existsSync(summaryPath)) {
              const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
              const experimentId = summary.experiment_id;
              const resultFile = `${experimentId}_results.json`;
              const resultPath = path.join(resultsDir, resultFile);
              
              if (fs.existsSync(resultPath)) {
                const result = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
                
                comment += `✅ Experiment completed successfully!\n\n`;
                comment += `**Experiment ID:** ${result.experiment_id}\n\n`;
                comment += `**Overall Metrics:**\n`;
                comment += `- Tasks completed: ${result.overall_metrics.tasks_completed}\n`;
                comment += `- Total samples: ${result.overall_metrics.total_samples}\n`;
                
                if (result.overall_metrics.average_accuracy !== null) {
                  comment += `- Average accuracy: ${(result.overall_metrics.average_accuracy * 100).toFixed(1)}%\n`;
                }
                
                comment += `\n**Task-wise Results:**\n`;
                for (const [taskName, taskResult] of Object.entries(result.task_results)) {
                  if (taskResult.error) {
                    comment += `- ${taskName}: ❌ Error - ${taskResult.error}\n`;
                  } else {
                    const accuracy = taskResult.metrics.average_score !== null 
                      ? (taskResult.metrics.average_score * 100).toFixed(1) + '%'
                      : 'N/A';
                    comment += `- ${taskName}: ${accuracy} (${taskResult.metrics.total_samples} samples)\n`;
                  }
                }
                
                comment += `\n**Results saved to:** \`docs/results/${resultFile}\`\n`;
              } else {
                comment += `⚠️ Results file not found for experiment ${experimentId}.\n`;
              }
            } else {
              // Fallback: try to find the most recent result file
              if (fs.existsSync(resultsDir)) {
                const files = fs.readdirSync(resultsDir);
                const resultFiles = files.filter(f => f.endsWith('_results.json'));
                
                if (resultFiles.length > 0) {
                  // Get the most recent result by modification time
                  const fileStats = resultFiles.map(f => ({
                    name: f,
                    mtime: fs.statSync(path.join(resultsDir, f)).mtime
                  }));
                  fileStats.sort((a, b) => b.mtime - a.mtime);
                  const latestFile = fileStats[0].name;
                  const resultPath = path.join(resultsDir, latestFile);
                  const result = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
                  
                  comment += `✅ Experiment completed successfully!\n\n`;
                  comment += `**Experiment ID:** ${result.experiment_id}\n\n`;
                  comment += `**Overall Metrics:**\n`;
                  comment += `- Tasks completed: ${result.overall_metrics.tasks_completed}\n`;
                  comment += `- Total samples: ${result.overall_metrics.total_samples}\n`;
                  
                  if (result.overall_metrics.average_accuracy !== null) {
                    comment += `- Average accuracy: ${(result.overall_metrics.average_accuracy * 100).toFixed(1)}%\n`;
                  }
                  
                  comment += `\n**Task-wise Results:**\n`;
                  for (const [taskName, taskResult] of Object.entries(result.task_results)) {
                    if (taskResult.error) {
                      comment += `- ${taskName}: ❌ Error - ${taskResult.error}\n`;
                    } else {
                      const accuracy = taskResult.metrics.average_score !== null 
                        ? (taskResult.metrics.average_score * 100).toFixed(1) + '%'
                        : 'N/A';
                      comment += `- ${taskName}: ${accuracy} (${taskResult.metrics.total_samples} samples)\n`;
                    }
                  }
                  
                  comment += `\n**Results saved to:** \`docs/results/${latestFile}\`\n`;
                  comment += `\n⚠️ Note: Used fallback method to find results file. Summary file not found.\n`;
                } else {
                  comment += '⚠️ Experiment completed but results file not found.\n';
                }
              } else {
                comment += '⚠️ Results directory not found.\n';
              }
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Close issue
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if the "Run experiment" step succeeded
            const experimentOutcome = '${{ steps.run-experiment.outcome }}';
            if (experimentOutcome === 'success') {
              github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
            }
      
      - name: Commit and push results
        if: steps.run-experiment.outcome == 'success'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Function to safely pull with handling of untracked files
          safe_pull() {
            # Stash any untracked files that might conflict
            git add docs/results/ || true
            git stash push -u -m "temp-untracked-$(date +%s)" || true
            # Pull latest changes
            git pull --rebase origin main || git pull origin main || true
            # Restore stashed files if any
            git stash pop || true
          }
          
          # Initial pull
          safe_pull
          
          # Add docs/results/ (main results directory)
          git add docs/results/
          
          # Check if there are any changes to commit
          if ! git diff --staged --quiet; then
            git commit -m "Save experiment results [skip ci]"
            
            # Retry push with exponential backoff to handle race conditions
            max_retries=3
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              if git push origin main; then
                echo "✅ Results committed and pushed to repository"
                break
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "⚠️ Push failed, pulling latest changes and retrying (attempt $retry_count/$max_retries)..."
                  sleep $((retry_count * 2))
                  safe_pull
                  # Re-add files in case they were updated
                  git add docs/results/
                  # Amend commit if needed, or create new one
                  if git diff --staged --quiet; then
                    git commit --amend --no-edit || true
                  else
                    git commit -m "Save experiment results [skip ci]"
                  fi
                else
                  echo "❌ Failed to push after $max_retries attempts"
                  exit 1
                fi
              fi
            done
          else
            echo "⚠️ No changes to commit (results may already be up to date)"
          fi
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: experiment-results-${{ github.event.issue.number }}
          path: docs/results/
          retention-days: 90

