name: Run Experiment

on:
  issues:
    types: [opened, edited]

jobs:
  run-experiment:
    if: |
      contains(join(github.event.issue.labels.*.name, ','), 'experiment') ||
      startsWith(github.event.issue.title, '[Experiment]')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run experiment
        id: run-experiment
        env:
          AWS_BEARER_TOKEN_BEDROCK: ${{ secrets.AWS_BEARER_TOKEN_BEDROCK }}
        run: |
          python -m src.issue_processor_github "${{ github.event.issue.body }}" "${{ github.event.issue.number }}"
          # The script will exit with code 1 if success rate < 100%, causing the workflow to fail
      
      - name: Comment results on issue
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## Experiment Results\n\n';
            
            // Try to read results file
            const resultsDir = path.join(process.cwd(), 'results');
            if (fs.existsSync(resultsDir)) {
              const files = fs.readdirSync(resultsDir);
              const resultFiles = files.filter(f => f.endsWith('_results.json'));
              
              if (resultFiles.length > 0) {
                // Get the most recent result
                const latestFile = resultFiles.sort().reverse()[0];
                const resultPath = path.join(resultsDir, latestFile);
                const result = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
                
                comment += `✅ Experiment completed successfully!\n\n`;
                comment += `**Experiment ID:** ${result.experiment_id}\n\n`;
                comment += `**Overall Metrics:**\n`;
                comment += `- Tasks completed: ${result.overall_metrics.tasks_completed}\n`;
                comment += `- Total samples: ${result.overall_metrics.total_samples}\n`;
                
                if (result.overall_metrics.average_accuracy !== null) {
                  comment += `- Average accuracy: ${(result.overall_metrics.average_accuracy * 100).toFixed(1)}%\n`;
                }
                
                comment += `\n**Task-wise Results:**\n`;
                for (const [taskName, taskResult] of Object.entries(result.task_results)) {
                  if (taskResult.error) {
                    comment += `- ${taskName}: ❌ Error - ${taskResult.error}\n`;
                  } else {
                    const accuracy = taskResult.metrics.average_score !== null 
                      ? (taskResult.metrics.average_score * 100).toFixed(1) + '%'
                      : 'N/A';
                    comment += `- ${taskName}: ${accuracy} (${taskResult.metrics.total_samples} samples)\n`;
                  }
                }
                
                comment += `\n**Results saved to:** \`results/${latestFile}\`\n`;
              } else {
                comment += '⚠️ Experiment completed but results file not found.\n';
              }
            } else {
              comment += '⚠️ Results directory not found.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Close issue
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // Check if the "Run experiment" step succeeded
            const experimentOutcome = '${{ steps.run-experiment.outcome }}';
            if (experimentOutcome === 'success') {
              github.rest.issues.update({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'closed'
              });
            }
      
      - name: Update GitHub Pages
        if: steps.run-experiment.outcome == 'success'
        run: |
          python scripts/update_gh_pages.py
      
      - name: Commit and push GitHub Pages update
        if: steps.run-experiment.outcome == 'success'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/results/
          git diff --staged --quiet || git commit -m "Update GitHub Pages with experiment results [skip ci]"
          git push
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: experiment-results-${{ github.event.issue.number }}
          path: results/
          retention-days: 90

