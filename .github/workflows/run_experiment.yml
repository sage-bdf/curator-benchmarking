name: Run Experiment

on:
  issues:
    types: [opened, edited]

jobs:
  run-experiment:
    if: contains(github.event.issue.labels.*.name, 'experiment')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure AWS credentials
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "AWS credentials configured"
      
      - name: Run experiment
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          python -m src.issue_processor_github "${{ github.event.issue.body }}" "${{ github.event.issue.number }}"
          # The script will exit with code 1 if success rate < 100%, causing the workflow to fail
      
      - name: Comment results on issue
        uses: actions/github-script@v7
        if: always()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## Experiment Results\n\n';
            
            // Try to read results file
            const resultsDir = path.join(process.cwd(), 'results');
            if (fs.existsSync(resultsDir)) {
              const files = fs.readdirSync(resultsDir);
              const resultFiles = files.filter(f => f.endsWith('_results.json'));
              
              if (resultFiles.length > 0) {
                // Get the most recent result
                const latestFile = resultFiles.sort().reverse()[0];
                const resultPath = path.join(resultsDir, latestFile);
                const result = JSON.parse(fs.readFileSync(resultPath, 'utf8'));
                
                comment += `✅ Experiment completed successfully!\n\n`;
                comment += `**Experiment ID:** ${result.experiment_id}\n\n`;
                comment += `**Metrics:**\n`;
                comment += `- Total samples: ${result.metrics.total_samples}\n`;
                
                if (result.metrics.average_score !== null) {
                  comment += `- Average score: ${(result.metrics.average_score * 100).toFixed(1)}%\n`;
                }
                
                comment += `\n**Results saved to:** \`results/${latestFile}\`\n`;
              } else {
                comment += '⚠️ Experiment completed but results file not found.\n';
              }
            } else {
              comment += '⚠️ Results directory not found.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
      
      - name: Close issue
        uses: actions/github-script@v7
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'closed'
            });
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: experiment-results-${{ github.event.issue.number }}
          path: results/
          retention-days: 90

